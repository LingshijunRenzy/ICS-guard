import{d as G,r as v,A as J,o as $,a as b,b as n,q as a,s as l,u as r,T as q,x as i,U as W,V as X,E as I,e as g,W as m,F as Z,f as K,C as L,X as Q,v as ee,w as te,G as ae,t as c,Y as le,p as T,l as f,Z as se,_ as oe}from"./index-qxG7-ExM.js";const ne={class:"audit-container"},ie={class:"page-header"},re={class:"header-actions"},de={class:"cli-text-primary"},ue={key:0,class:"cli-tag-info"},ce={key:1},pe={class:"pagination-container"},_e={key:0,class:"log-detail"},me={class:"detail-item"},fe={class:"value"},ve={class:"detail-item"},ge={class:"value"},be={key:0,class:"detail-item"},ye={class:"value cli-text-danger"},he={class:"detail-item full-width"},we={class:"cli-code-block"},Se=G({__name:"AuditView",setup(Ve){const w=v(!1),k=v([]),x=v(0),A=v([]),s=J({start_time:"",end_time:"",action:"",status:"",resource:"",page:1,per_page:20}),d=v(null);async function U(){try{A.value=await W()}catch(o){console.error("Failed to load audit actions",o)}}async function y(){w.value=!0;try{d.value?(s.start_time=d.value[0],s.end_time=d.value[1]):(s.start_time="",s.end_time="");const o=await X(s);k.value=o.logs,x.value=o.total}catch{I.error("获取审计日志失败")}finally{w.value=!1}}function C(){s.page=1,y()}function O(){d.value=null,s.action="",s.status="",s.resource="",s.page=1,y()}async function M(){try{const o=await se({start_time:d.value?d.value[0]:void 0,end_time:d.value?d.value[1]:void 0,action:s.action||void 0,status:s.status||void 0,resource:s.resource||void 0}),e=window.URL.createObjectURL(new Blob([o])),u=document.createElement("a");u.href=e,u.setAttribute("download",`audit_logs_${m().format("YYYYMMDD_HHmmss")}.csv`),document.body.appendChild(u),u.click(),document.body.removeChild(u)}catch{I.error("导出失败")}}const p=v(null),S=v(!1);function N(o){p.value=o,S.value=!0}function z(o){return o.includes("DELETE")||o.includes("STOP")||o.includes("DISABLE")?"danger":o.includes("CREATE")||o.includes("START")||o.includes("ENABLE")?"success":o.includes("UPDATE")||o.includes("APPLY")?"warning":"info"}return $(()=>{U(),y()}),(o,e)=>{const u=i("el-button"),B=i("el-date-picker"),h=i("el-form-item"),V=i("el-option"),D=i("el-select"),P=i("el-form"),E=i("el-card"),_=i("el-table-column"),Y=i("el-tag"),H=i("el-table"),R=i("el-pagination"),F=i("el-dialog"),j=ae("loading");return f(),b("div",ne,[n("div",ie,[e[7]||(e[7]=n("div",{class:"header-left"},[n("h2",{class:"cli-title"},"SYSTEM_AUDIT_LOGS"),n("p",{class:"cli-subtitle"},"系统操作审计与追溯")],-1)),n("div",re,[a(u,{type:"primary",icon:r(q),onClick:M},{default:l(()=>[...e[6]||(e[6]=[g("导出日志 (CSV)",-1)])]),_:1},8,["icon"])])]),a(E,{class:"filter-card cli-card"},{default:l(()=>[a(P,{inline:!0,model:s,class:"filter-form"},{default:l(()=>[a(h,{label:"时间范围"},{default:l(()=>[a(B,{modelValue:d.value,"onUpdate:modelValue":e[0]||(e[0]=t=>d.value=t),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间","value-format":"YYYY-MM-DDTHH:mm:ss",shortcuts:[{text:"最近1小时",value:()=>[r(m)().subtract(1,"hour").toISOString(),r(m)().toISOString()]},{text:"最近24小时",value:()=>[r(m)().subtract(24,"hour").toISOString(),r(m)().toISOString()]},{text:"最近7天",value:()=>[r(m)().subtract(7,"day").toISOString(),r(m)().toISOString()]}]},null,8,["modelValue","shortcuts"])]),_:1}),a(h,{label:"操作类型"},{default:l(()=>[a(D,{modelValue:s.action,"onUpdate:modelValue":e[1]||(e[1]=t=>s.action=t),placeholder:"全部",clearable:"",style:{width:"180px"}},{default:l(()=>[(f(!0),b(Z,null,K(A.value,t=>(f(),L(V,{key:t,label:t,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(h,{label:"状态"},{default:l(()=>[a(D,{modelValue:s.status,"onUpdate:modelValue":e[2]||(e[2]=t=>s.status=t),placeholder:"全部",clearable:"",style:{width:"120px"}},{default:l(()=>[a(V,{label:"成功",value:"success"}),a(V,{label:"失败",value:"failure"})]),_:1},8,["modelValue"])]),_:1}),a(h,null,{default:l(()=>[a(u,{type:"primary",icon:r(Q),onClick:C},{default:l(()=>[...e[8]||(e[8]=[g("查询",-1)])]),_:1},8,["icon"]),a(u,{icon:r(ee),onClick:O},{default:l(()=>[...e[9]||(e[9]=[g("重置",-1)])]),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),a(E,{class:"table-card cli-card"},{default:l(()=>[te((f(),L(H,{data:k.value,style:{width:"100%"},class:"cli-table"},{default:l(()=>[a(_,{prop:"created_at",label:"时间",width:"180"},{default:l(({row:t})=>[g(c(r(m)(t.created_at).format("YYYY-MM-DD HH:mm:ss")),1)]),_:1}),a(_,{prop:"username",label:"用户",width:"120"},{default:l(({row:t})=>[n("span",de,c(t.username||"System"),1)]),_:1}),a(_,{prop:"action",label:"操作","min-width":"150"},{default:l(({row:t})=>[a(Y,{type:z(t.action),effect:"dark",class:"cli-tag"},{default:l(()=>[g(c(t.action),1)]),_:2},1032,["type"])]),_:1}),a(_,{prop:"resource",label:"资源",width:"120"},{default:l(({row:t})=>[t.resource?(f(),b("span",ue,c(t.resource),1)):(f(),b("span",ce,"-"))]),_:1}),a(_,{prop:"resource_id",label:"资源ID","min-width":"200","show-overflow-tooltip":""}),a(_,{prop:"ip_address",label:"IP地址",width:"140"}),a(_,{prop:"status",label:"状态",width:"100"},{default:l(({row:t})=>[a(Y,{type:t.status==="success"?"success":"danger",size:"small"},{default:l(()=>[g(c(t.status==="success"?"成功":"失败"),1)]),_:2},1032,["type"])]),_:1}),a(_,{label:"操作",width:"100",fixed:"right"},{default:l(({row:t})=>[a(u,{link:"",type:"primary",icon:r(le),onClick:ke=>N(t)},{default:l(()=>[...e[10]||(e[10]=[g("详情",-1)])]),_:1},8,["icon","onClick"])]),_:1})]),_:1},8,["data"])),[[j,w.value]]),n("div",pe,[a(R,{"current-page":s.page,"onUpdate:currentPage":e[3]||(e[3]=t=>s.page=t),"page-size":s.per_page,"onUpdate:pageSize":e[4]||(e[4]=t=>s.per_page=t),total:x.value,"page-sizes":[20,50,100],layout:"total, sizes, prev, pager, next",onSizeChange:C,onCurrentChange:y},null,8,["current-page","page-size","total"])])]),_:1}),a(F,{modelValue:S.value,"onUpdate:modelValue":e[5]||(e[5]=t=>S.value=t),title:"审计日志详情",width:"600px",class:"cli-dialog"},{default:l(()=>[p.value?(f(),b("div",_e,[n("div",me,[e[11]||(e[11]=n("span",{class:"label"},"操作用户:",-1)),n("span",fe,c(p.value.username)+" (ID: "+c(p.value.user_id)+")",1)]),n("div",ve,[e[12]||(e[12]=n("span",{class:"label"},"User Agent:",-1)),n("span",ge,c(p.value.user_agent),1)]),p.value.error_message?(f(),b("div",be,[e[13]||(e[13]=n("span",{class:"label"},"错误信息:",-1)),n("span",ye,c(p.value.error_message),1)])):T("",!0),n("div",he,[e[14]||(e[14]=n("span",{class:"label"},"Payload Snapshot:",-1)),n("pre",we,c(p.value.payload_snapshot?JSON.stringify(JSON.parse(p.value.payload_snapshot),null,2):"None"),1)])])):T("",!0)]),_:1},8,["modelValue"])])}}}),Ae=oe(Se,[["__scopeId","data-v-0337e4ef"]]);export{Ae as default};
