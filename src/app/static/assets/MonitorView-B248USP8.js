import{d as I,r as z,A as v,o as E,B as O,a as f,q as c,s as i,x as h,C as y,b as p,t as _,n as $,z as W,l as d,_ as D}from"./index-qxG7-ExM.js";const L={class:"monitor-layout"},U={class:"flow-id"},V={class:"mono"},A={class:"cli-tag cli-tag-primary"},J={class:"cli-tag cli-tag-secondary"},M={key:1},T={key:0},j={key:1},q={key:1},G={key:1},H={class:"mono"},K=["title"],P=I({__name:"MonitorView",setup(Q){const w=z(!0),m=v([]),b=v({});function C(n){if(!n)return"cli-tag-info";const a=n.toLowerCase();return a==="dangerous"?"cli-tag-dangerous":a==="suspicious"?"cli-tag-suspicious":a==="safe"?"cli-tag-safe":"cli-tag-info"}let u=null;function S(n){const a=n.type,t=n.data;if(!t)return"-";if(a==="network_status_update")return`节点 ${t.node_id} 状态变更为 ${t.status?.toUpperCase()}`;if(a==="traffic_anomaly")return`流量 ${t.flow_id} (${t.src_ip} -> ${t.dst_ip}) 异常，分数: ${t.anomaly_score}。详情: ${t.details}`;if(a==="honeypot_interaction")return`蜜罐收到来自 ${t.source_ip} 的请求: ${t.request}`;if(a==="topology_change")return`拓扑变更: ${t.change_type}`;if(a==="flow_update"){const o=t.flow||t,s=o.src_ip||o.source||o.src||"?",l=o.dst_ip||o.destination||o.dst||"?",r=o.status||"unknown";return`Flow ${o.id||o.flow_id} (${s} -> ${l}) 更新，状态: ${r}`}return a==="flow_detection_update"?`Flow ${t.flow_id} 检测更新: ${t.detect_status} (置信度: ${(t.prob*100).toFixed(1)}%)`:JSON.stringify(t)}function x(n){return{network_status_update:"网络状态",traffic_anomaly:"流量异常",honeypot_interaction:"蜜罐交互",topology_change:"拓扑变更",flow_update:"流量更新",flow_detection_update:"检测更新"}[n]||n}function F(n){return n==="traffic_anomaly"||n==="honeypot_interaction"?"#FF7C7C":n==="network_status_update"||n==="topology_change"?"#ffe47c":"#d0d7de"}function N(n){m.push(n),m.length>200&&m.splice(0,m.length-200)}function B(){const n=window.location.protocol==="https:"?"wss":"ws",a=window.location.hostname;return`${n}://${a}:8766/ui-events`}function k(){const n=B();u=new WebSocket(n),w.value=!0,u.onopen=()=>{w.value=!1},u.onmessage=a=>{try{const t=JSON.parse(a.data);if(!t||!t.type||!t.timestamp)return;if(N(t),t.type==="flow_update"){const o=t.data||{},s=o.flow||o,l=s.flow_id||s.id;if(!l)return;const r=b[l]||{flow_id:l,timestamp:t.timestamp},e=s.src_ip||s.source||s.src,g=s.dst_ip||s.destination||s.dst;b[l]={...r,src_ip:e,dst_ip:g,src_port:s.src_port,dst_port:s.dst_port,protocol:s.protocol,detect_status:s.detect_status??r.detect_status??"pending",policy_effects:s.policy_effects??r.policy_effects,redirect_to:s.redirect_to??r.redirect_to,final_dst:s.final_dst??r.final_dst,blocked:s.blocked??r.blocked,blocked_at:s.blocked_at??r.blocked_at,block_reason:s.block_reason??r.block_reason,path_hops:s.path_hops??r.path_hops,timestamp:t.timestamp}}else if(t.type==="flow_detection_update"){const o=t.data||{},s=o.flow_id;if(!s)return;const l=b[s];if(!l)return;b[s]={...l,detect_status:o.detect_status??l.detect_status,prob:typeof o.prob=="number"?o.prob:l.prob,decision_level:o.decision_level??l.decision_level,timestamp:l.timestamp}}}catch(t){console.error("解析 WS 消息失败",t)}},u.onclose=()=>{w.value=!1,setTimeout(()=>{k()},1e3)},u.onerror=a=>{console.error("WS 连接出错",a)}}return E(()=>{k()}),O(()=>{u&&(u.close(),u=null)}),(n,a)=>{const t=h("el-empty"),o=h("el-table-column"),s=h("el-table"),l=h("el-card"),r=h("el-alert");return d(),f("div",L,[c(l,{class:"flows-card"},{header:i(()=>[...a[0]||(a[0]=[p("span",null,"Flow 实时监控（含检测状态）",-1)])]),default:i(()=>[Object.keys(b).length===0?(d(),y(t,{key:0,description:"当前没有收到任何 Flow 事件"})):(d(),y(s,{key:1,data:Object.values(b).sort((e,g)=>e.timestamp<g.timestamp?1:-1),size:"small",height:"260",border:"",stripe:""},{default:i(()=>[c(o,{prop:"flow_id",label:"Flow ID","min-width":"220"},{default:i(({row:e})=>[p("div",U,_(e.flow_id),1)]),_:1}),c(o,{prop:"timestamp",label:"时间",width:"200"},{default:i(({row:e})=>[p("div",V,_(new Date(e.timestamp).toLocaleString()),1)]),_:1}),c(o,{label:"源 -> 目的","min-width":"260"},{default:i(({row:e})=>[p("span",A,_(e.src_ip||"N/A")+_(e.src_port?":"+e.src_port:""),1),a[1]||(a[1]=p("span",{class:"arrow"},"→",-1)),p("span",J,_(e.dst_ip||"N/A")+_(e.dst_port?":"+e.dst_port:""),1)]),_:1}),c(o,{prop:"protocol",label:"协议",width:"100"}),c(o,{label:"检测状态",width:"150"},{default:i(({row:e})=>[e.detect_status?(d(),f("span",{key:0,class:$(["cli-tag",C(e.detect_status)])},_(e.detect_status.toUpperCase()),3)):(d(),f("span",M,"-"))]),_:1}),c(o,{label:"得分",width:"100"},{default:i(({row:e})=>[typeof e.prob=="number"?(d(),f("span",T,_((e.prob*100).toFixed(1))+"%",1)):(d(),f("span",j,"-"))]),_:1}),c(o,{prop:"decision_level",label:"决策等级",width:"140"}),c(o,{label:"阻断状态",width:"100"},{default:i(({row:e})=>[e.blocked!==void 0?(d(),f("span",{key:0,class:$(["cli-tag",e.blocked?"cli-tag-dangerous":"cli-tag-safe"])},_(e.blocked?"已阻断":"未阻断"),3)):(d(),f("span",q,"-"))]),_:1}),c(o,{prop:"block_reason",label:"阻断原因",width:"150"})]),_:1},8,["data"]))]),_:1}),c(l,{class:"events-card"},{header:i(()=>[...a[2]||(a[2]=[p("span",null,"实时事件流（WS）",-1)])]),default:i(()=>[w.value?(d(),y(r,{key:0,title:"正在连接实时事件通道...",type:"info","show-icon":"",class:"mb-2"})):(d(),f("div",G,[m.length===0?(d(),y(t,{key:0,description:"当前没有收到任何实时事件"})):(d(),y(s,{key:1,data:m.slice().reverse(),size:"small",height:"260",border:"",stripe:""},{default:i(()=>[c(o,{label:"时间",width:"180"},{default:i(({row:e})=>[p("div",H,_(new Date(e.timestamp).toLocaleString()),1)]),_:1}),c(o,{label:"事件类型",width:"120"},{default:i(({row:e})=>[p("span",{class:"cli-tag",style:W({backgroundColor:F(e.type),color:"#000000"})},_(x(e.type)),5)]),_:1}),c(o,{label:"内容"},{default:i(({row:e})=>[p("div",{class:"event-content",title:JSON.stringify(e.data,null,2)},_(S(e)),9,K)]),_:1})]),_:1},8,["data"]))]))]),_:1})])}}}),X=D(P,[["__scopeId","data-v-7960b467"]]);export{X as default};
